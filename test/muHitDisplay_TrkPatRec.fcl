# -*- mode: tcl -*-
BEGIN_PROLOG
bgHitFiles : [
     "/mu2e/data/tdr/beam/mixp3/tdr.beam.mix.bg.1516a.15445532/good/00146/data_mixBG.root"
]
END_PROLOG
# -*- mode: tcl -*-
// 2014-06-02: run local, write output file
//
// Andrei Gaponenko, 2014
#------------------------------------------------------------------------------
# quick comments: reads signal MC and also background MC inputs with steppoints
# so need to define input and 
#------------------------------------------------------------------------------

#include "minimalMessageService.fcl"
#include "standardProducers.fcl"
#include "standardServices.fcl"


#include "Stntuple/fcl/prolog.fcl"

BEGIN_PROLOG

g4ModuleLabel   : g4run

END_PROLOG

process_name : readTrkPatRecSplit

source : { 
    module_type : EmptyEvent
#    module_type : RootInput
#    fileNames   : [ {INPUT_DATA_FILE} ]
#    fileNames : ["/mu2e/data/tdr/beam/g4s4p7/tdr.beam.g4s4.flat.1812b.16762780/good/00000/dsStopsToHitsFlat.root"]
#    maxEvents   : 100

#    inputCommands : ['keep *_*_*_*'
#		     , 'drop *_muonTimeMap_*_*'
#		     , 'drop *_protonTimeMap_*_*'
#		     , 'drop mu2eStrawDigis_*_*_*'
#		     , 'drop mu2eStrawHits_*_*_*'
#		     , 'drop *_CaloReadoutHitsMaker_*_*'
#		     , 'drop *_CaloCrystalHitsMaker_*_*'
# Uncomment the above lines to reduce file size.
#		     ]  
}

services : {

    message               : @local::default_message
    TFileService          : { fileName : "{ART_HIST_FILE}" }
#    TFileService: { fileName : "digiMixAndTrackFile.hist" }
    RandomNumberGenerator : { }

    user : {
        GeometryService        : { inputFile      : "JobConfig/TDR/geom_MothersToHits.txt" }
        ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"        }
        GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt"   }
        BTrkHelper             : @local::BTrkHelperDefault
        G4Helper               : { }
        SeedService            : @local::automaticSeeds
    }
}

physics : {

    producers: {
	generate             : {
#------------------------------------------------------------------------------
# for 105 MeV/c electron : E = 105.00130           MeV
# for muon: sqrt(105.*105+105.658*105.658) = 148.9584269653785
#------------------------------------------------------------------------------
	    module_type      : StoppedParticleReactionGun
	    physics          : {
		pdgId              : 11
		spectrumVariable   : "totalEnergy"
		spectrumShape      : "conversion"
		spectrumResolution : 0.1
#		spectrumShape    : "flat"
#		elow               : 95.
#		ehi              : 105.
	    }
	    muonStops            : {
#------------------------------------------------------------------------------
# use --fclinput=@muStops:datasets/mustops for grid submission 
# [ "mergedMuonStops/mustops.1025a_1426a_1504a.15318715.root" ] 
#------------------------------------------------------------------------------
		inputFiles            : [ "mergedMuonStops/mustops.1025a_1426a_1504a.15318715.root" ]
		#@local::muStops
		averageNumRecordsToUse: 500000
		treeName              : "stoppedMuonDumper/stops"
		branchName            : "stops"
		verbosityLevel        : 1
	    }
	}
	
	g4run                : @local::g4run


#------------------------------------------------------------------------------
# hit makers
#------------------------------------------------------------------------------
	CaloReadoutHitsMaker : @local::MakeCaloReadoutHits
	CaloCrystalHitsMaker : @local::CaloCrystalHitsMaker
        protonTimeMap        : { module_type : GenerateProtonTimes }
        muonTimeMap          : { module_type : GenerateMuonLife }
        makeSD               : @local::makeSD
        makeSH               : @local::makeSHfromSD

#------------------------------------------------------------------------------
#  default tracking
#------------------------------------------------------------------------------
	FSHPreStereo         : @local::FSHPreStereo
	MakeStereoHits       : @local::MakeStereoHits
	FlagStrawHits        : @local::FlagStrawHits
	FlagBkgHits          : @local::FlagBkgHits
	TrkPatRec            : @local::TrkPatRecDownstreameMinus

#------------------------------------------------------------------------------
# CalPatRec modules
#------------------------------------------------------------------------------
	MakeCaloCluster      : @local::MakeCaloCluster

#------------------------------------------------------------------------------
# needed for analysis
#------------------------------------------------------------------------------
	CaloMatching         : @local::TrackCaloMatching
	TrkExtrapol          : @local::TrkExtrapol
	ParticleID           : @local::ParticleID
    }

    filters: {


#------------------------------------------------------------------------------
# Andrej's filter
# Reject events with no hits from signal-like tracks in the detectors.  
# The filter does not look at the background hits from mixed events.
#------------------------------------------------------------------------------
	FilterStepPointMomentum: {
            module_type    : FilterStepPointMomentum
            inputs         : [ "g4run:tracker", "g4run:calorimeter", "g4run:calorimeterRO"]
            cutMomentumMin : 10. # MeV/c
        }

	MuHitDisplay         : @local::MuHitDisplay

    }
#------------------------------------------------------------------------------
# paths
# write out ntuple only, so don't need compression modules...
#------------------------------------------------------------------------------
p1 : [generate, g4run
#	  , FilterStepPointMomentum
	  , protonTimeMap, muonTimeMap 
	  , makeSD, makeSH
	  , CaloReadoutHitsMaker, CaloCrystalHitsMaker
	  , MakeCaloCluster
# 
	  , FSHPreStereo, MakeStereoHits, FlagStrawHits, FlagBkgHits
	  , TrkPatRec 
	  #	  
	  , TrkExtrapol, CaloMatching, ParticleID
#
	   ,MuHitDisplay
	 ]

    trigger_paths  : [p1]
    
#    out : [detectorOutput]
out : []
#    an  : [genCountLogger]
    end_paths      : [out]
}

outputs: {
    detectorOutput : {
        module_type : RootOutput
        SelectEvents: { SelectEvents: [p1] }
#        outputCommands:   [ "keep *_*_*_*",
#                            "drop uintmu2e::PhysicalVolumeInfomvstd::pairs_g4run_*_*"
#                          ]
        fileName    : "trkPatRec.art"
    }
}
#------------------------------------------------------------------------------
# redefinitions
#------------------------------------------------------------------------------
# 1. only for interactive submission
#------------------------------------------------------------------------------
services.user.SeedService.baseSeed             :  0
services.user.SeedService.maxUniqueEngines     :  20

# print per event timing for ::event entry points
services.Timing: { }
# print 
services.scheduler.wantSummary: true
services.TFileService.fileName            : "muHitTrkPatRec.hist"


physics.producers.makeSD.g4ModuleLabel               : @local::g4ModuleLabel
physics.producers.CaloReadoutHitsMaker.g4ModuleLabel : @local::g4ModuleLabel

physics.producers.MakeCaloCluster.EnoiseCut                      : 0.10 # MeV
physics.producers.MakeCaloCluster.EclusterCut                    : 1.0  # MeV  


# Apply the time offsets in tracker digitization
physics.producers.makeSD.TimeOffsets               : { inputs : [ "protonTimeMap", "muonTimeMap" ] }
physics.producers.CaloReadoutHitsMaker.TimeOffsets : { inputs : [ "protonTimeMap", "muonTimeMap" ] }
physics.producers.makeSD.g4ModuleLabel               : @local::g4ModuleLabel
physics.producers.makeSH.g4ModuleLabel               : @local::g4ModuleLabel
physics.producers.CaloReadoutHitsMaker.g4ModuleLabel : @local::g4ModuleLabel

# physics.producers.CalPatRec.minClusterEnergy         : 30.
# physics.producers.CalPatRec. minClusterSize          : 2
# physics.producers.CalPatRec.HelixFit.distPatRec      : 100.
# physics.producers.CalPatRec.BackgroundSelectionBits  : ["DeltaRay","Isolated"]
# physics.producers.CalPatRec.debugLevel                           : 1
# physics.producers.CalPatRec.HelixFit.debugLevel                  : 1
# physics.producers.CalPatRec.HelixFit.minDfDz                     : 0.002
# physics.producers.CalPatRec.HelixFit.maxDfDz                     : 0.01


# debugging: don't use TPeak
# physics.producers.CalPatRec.KalFit.daveMode                      : 0
# physics.producers.CalPatRec.KalFit.debugLevel                  : 1

physics.producers.TrkExtrapol.fitterModuleLabel      : TrkPatRec
#physics.producers.CaloMatching.meanInteractionDepth  : 0.0
physics.producers.CaloMatching.fitterModuleLabel     : TrkPatRec
physics.producers.ParticleID.fitterModuleLabel       : TrkPatRec


physics.filters.MuHitDisplay.strawHitPosMakerModuleLabel  : MakeStereoHits
physics.filters.MuHitDisplay.strawHitFlagMakerModuleLabel : FlagBkgHits
physics.filters.MuHitDisplay.trkPatRecModuleLabel         : TrkPatRec

services.scheduler.defaultExceptions : false
services.user.SeedService.policy           :  autoIncrement
services.user.SeedService.maxUniqueEngines :  20
services.user.SeedService.baseSeed         :  510638692
source.firstRun     : 18690718
source.firstSubRun  : 0
source.firstEvent   : 1

#physics.producers.FlagStrawHits.minimumTime : 400.
#physics.producers.TrkRecFit.tmin            : 400.
#physics.producers.CalPatRec.tmin            : 400.