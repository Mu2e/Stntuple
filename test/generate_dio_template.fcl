# -*- mode: tcl -*-
// Read an input file with StepPointMCs (usually for signal or signal-like tracks),
// overlay background hits using standard pre-mixed files,
// run tracker digitization and reconstruction.
//
// To specify background hit files for grid submissions, add the
//
//     --fclinput=1:@bgHitFiles:/mu2e/data/tdr/beam/mixp3/filelist.txt
//
// option to mu2eart command line.
//
// An example of analyzing one file (1000 generated conversions):
//
//     ls /mu2e/data/tdr/beam/g4s4p5/tdr.beam.g4s4.conversion.1504a.15729672/good/00000/dsStopsToHitsConversion.root > filelist.txt
//
//     mu2eart --setup=setup.sh  --fclinput=1:@bgHitFiles:/mu2e/data/tdr/beam/mixp3/filelist.txt --inputs=filelist.txt --fcl=JobConfig/TDR/digiMixFile.fcl --njobs=1
//
// For interactive tests, uncomment the
// following PROLOG definition of bgHitFiles.  DO NOT LEAVE IT UNCOMMENTED, as it
// will cause grid jobs to silently use the same file over and over again.
//
// Andrei Gaponenko, 2014

//test: // This must be commented out for production.
//test: BEGIN_PROLOG
//test: bgHitFiles : [ "/mu2e/data/tdr/beam/mixp3/tdr.beam.mix.bg.1516a.15409268/good/00000/data_mixBG.root"]
//test: END_PROLOG

#include "minimalMessageService.fcl"
#include "standardProducers.fcl"
#include "standardServices.fcl"

BEGIN_PROLOG
mixerTemplate: {
   module_type         : MixMCEvents
   fileNames           : @local::bgHitFiles
   readMode            : randomReplace
   wrapFiles           : true
   coverageFraction    : 1000000.
   detail : {
      mean                : -1
      genModuleLabel      : @nil
      g4ModuleLabel       : @nil
      g4StatusTag         : ""
      stepInstanceNames   : @local::stepInstanceNames
      doPointTrajectories : false
   }
}
END_PROLOG

process_name: digiMixFile

source: { module_type: RootInput }

services : {
   message: @local::default_message
   TFileService: { fileName : "hist_digiMixAndTrackFile.root" }
   RandomNumberGenerator: { }
   user: {
      GeometryService        : { inputFile      : "JobConfig/TDR/geom_MothersToHits.txt" }
      ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"      }
      GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt" }
      SeedService: @local::automaticSeeds
   }
}

physics: {

   filters: {
      dioMixer     : @local::mixerTemplate

      simParticleFilter: {
         module_type: FilterG4Out
         mainHitInputs : []
         extraHitInputs : [
            "detectorFilter:virtualdetector",
            "dioMixer:virtualdetector"
         ]
#         mainSPPtrInputs: [ "TSTMDownstreameMinusTmp", "TSTMUpstreameMinusTmp" ]
         vetoDaughters: []
         compressGenParticles: true

         simParticleIOMap : [
            {in : "detectorFilter:s0"    out : "signal" },
            {in : "dioMixer:s0"          out : "dio" },
         ]
      }
   }

   producers: {
      protonTimeMap: { module_type : GenerateProtonTimes }
      muonTimeMap: { module_type : GenerateMuonLife }
      makeSD: @local::makeSD
      makeSH: @local::makeSHfromSD
      FSHPreStereo: @local::FSHPreStereo
      MakeStereoHits: @local::MakeStereoHits
      FlagStrawHits: @local::FlagStrawHits
      FlagBkgHits: @local::FlagBkgHits

      protonTimeMapCompressed: {
         module_type: SimParticleTimeMapUpdater
         remapping: simParticleFilter
         inputTimeCollection: protonTimeMap
      }

      muonTimeMapCompressed: {
         module_type: SimParticleTimeMapUpdater
         remapping: simParticleFilter
         inputTimeCollection: muonTimeMap
      }

   }

   p1: [
      dioMixer, 
      protonTimeMap, muonTimeMap, makeSD, makeSH, FSHPreStereo,
      MakeStereoHits, FlagStrawHits, FlagBkgHits,
      simParticleFilter,
      protonTimeMapCompressed, muonTimeMapCompressed
   ]

   trigger_paths: [p1]

   e1: [ genCountLogger, RKFDownstreameMinus]
   out: [summaryOutput]
   end_paths      : [e1, out]
}

outputs: {
   summaryOutput : {
      module_type : RootOutput
      fileName    : "recoSummary.root"
      SelectEvents: { SelectEvents: [p1] }
      outputCommands: [
         "drop *_*_*_*",
         "keep mu2e::GenEventCount_*_*_*",
         "keep uintmu2e::PhysicalVolumeInfomvstd::pairs_*_*_*",
         "keep mu2e::StatusG4_*_*_*",
         "keep mu2e::TrackSummarys_*_*_*",
         "keep mu2e::*_simParticleFilter_*_*",
         "keep *_protonTimeMapCompressed_*_*",
         "keep *_muonTimeMapCompressed_*_*",
         "keep *_TSTMDownstreameMinus_*_*",
         "keep *_TSTMUpstreameMinus_*_*"
      ]
   }
}

// Apply the time offsets in tracker digitization
physics.producers.makeSD.TimeOffsets :  { inputs : [ "protonTimeMap", "muonTimeMap" ] }

physics.filters.dioMixer.detail.genModuleLabel     :  dioMixer
physics.filters.dioMixer.detail.g4ModuleLabel      :  dioMixer

services.user.SeedService.baseSeed         :  0
services.user.SeedService.maxUniqueEngines :  20
